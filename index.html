<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Factory Flow Simulation - Factory Dynamics</title>

    <!-- PWA Configuration -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4a90e2">
    <meta name="description" content="Factory Flow Simulation - Observe Lead Time, Work in Process and Throughput Rate by adjusting system parameters. Operations Management and Lean Production.">

    <!-- iOS Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Flow Sim">
    <link rel="apple-touch-icon" href="icon.png">

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="shortcut icon" type="image/png" href="icon.png">

    <!-- External CSS -->
    <link rel="stylesheet" href="styles.css">
    
    <!-- Chart.js and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/1.2.1/chartjs-plugin-zoom.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="main-card">
            <div class="header-bar">
                <div class="title-section">
                    <h1>Factory Flow Simulation</h1>
                    <p class="subtitle">Factory Dynamics - Observe Lead Time, Work in Process and Throughput Rate by adjusting system parameters.</p>
                    <p class="author">Operations Management and Lean Production - Filippo De Carlo</p>
                </div>
                <div class="header-actions">
                    <button id="themeToggle" class="btn btn--icon" title="Toggle Dark/Light Mode">
                        <span class="theme-icon">üåô</span>
                    </button>
                    <button id="installBtn" class="btn btn--success" style="display: none;">
                        <span class="btn-icon">üì±</span>Installa App
                    </button>
                </div>
            </div>

            <div class="control-panel">
                <div class="controls-row">
                    <div class="button-group">
                        <button id="startBtn" class="btn btn--primary"><span class="btn-icon">‚ñ∂</span>Start</button>
                        <button id="pauseBtn" class="btn btn--secondary" disabled><span class="btn-icon">‚è∏</span>Pause</button>
                        <button id="resetBtn" class="btn btn--outline"><span class="btn-icon">‚èπ</span>Reset</button>
                        <button id="stepBtn" class="btn btn--secondary"><span class="btn-icon">‚û°Ô∏è</span>Step</button>
                    </div>
                    <div class="input-group">
                        <label class="form-label">Constant WIP:</label>
                        <input id="wipInput" type="number" class="form-control input-small" min="1" max="1000" value="9">
                    </div>
                    <div class="input-group">
                        <label class="form-label">Speed:</label>
                        <input id="speedRange" type="range" class="speed-slider" min="1" max="200" step="1" value="10">
                        <span id="speedDisplay" class="speed-display">1.0x</span>
                    </div>
                    <div class="input-group">
                        <label class="form-label">Log Step (sec):</label>
                        <select id="logStepInput" class="form-control input-small">
                            <option value="1">1</option>
                            <option value="5" selected>5</option>
                            <option value="10">10</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label class="form-label">Zoom Window (sec):</label>
                        <input id="zoomWindowInput" type="number" class="form-control input-small" min="10" value="300">
                    </div>
                    <div class="input-group">
                        <label class="form-label">Warm-up (sec):</label>
                        <input id="warmupPeriodInput" type="number" class="form-control input-small" min="0" value="0">
                    </div>
                </div>

                <div class="metrics-grid">
                    <div class="metric-card"><div id="currentTime" class="metric-value time">0</div><div class="metric-label">Time (sec)</div></div>
                    <div class="metric-card"><div id="completedPieces" class="metric-value completed">0</div><div class="metric-label">Completed</div></div>
                    <div class="metric-card"><div id="throughputRate" class="metric-value throughput">0</div><div class="metric-label">Parts/hour</div></div>
                    <div class="metric-card"><div id="wipInLine" class="metric-value wip">0</div><div class="metric-label">WIP in Line</div></div>
                    <div class="metric-card"><div id="waitingQueue" class="metric-value queue">9</div><div class="metric-label">Waiting Queue</div></div>
                    <div class="metric-card"><div id="avgLeadTime" class="metric-value leadtime">0.0</div><div class="metric-label">Avg Lead Time (sec)</div></div>
                </div>
                <div id="convergenceIndicator" style="display: none; text-align: center;">Indicatore Convergenza</div>
            </div>

            <div class="production-line">
                <h3>Production Line</h3>
                <div id="movingPartsContainer"></div>
                
                <div class="line-container">
                    <div class="queue-container">
                        <div class="queue-box" id="inputQueueBox">
                            <div class="queue-label">IN</div>
                        </div>
                        <div class="queue-count">
                            <span id="queueCount">9</span>
                        </div>
                    </div>
                    <div class="arrow"></div>

                    <div class="station-container">
                        <div id="station1" class="station status-free">
                            <div class="station-id">S1</div>
                            <div id="station1Piece" class="piece-id"></div>
                            <div id="station1Time" class="remaining-time"></div>
                        </div>
                        <div class="progress-bar-container">
                            <div id="station1ProgressBar" class="progress-bar-fill"></div>
                        </div>
                        <div class="station-info">
                            <div id="station1DurationDisplay" class="duration-display">5.0s</div>
                            <div id="station1Status" class="status-display">free</div>
                        </div>
                    </div>
                    <div class="arrow"></div>

                    <div class="buffer-container">
                        <div id="buffer1" class="buffer">
                            <div class="buffer-id">B1</div>
                            <div id="buffer1Count" class="buffer-count">0/2</div>
                        </div>
                        <div id="buffer1Fill" class="buffer-fill">0%</div>
                    </div>
                    <div class="arrow"></div>

                    <div class="station-container">
                        <div id="station2" class="station status-free">
                            <div class="station-id">S2</div>
                            <div id="station2Piece" class="piece-id"></div>
                            <div id="station2Time" class="remaining-time"></div>
                        </div>
                        <div class="progress-bar-container">
                            <div id="station2ProgressBar" class="progress-bar-fill"></div>
                        </div>
                        <div class="station-info">
                            <div id="station2DurationDisplay" class="duration-display">4.0s</div>
                            <div id="station2Status" class="status-display">free</div>
                        </div>
                    </div>
                    <div class="arrow"></div>

                    <div class="buffer-container">
                        <div id="buffer2" class="buffer">
                            <div class="buffer-id">B2</div>
                            <div id="buffer2Count" class="buffer-count">0/2</div>
                        </div>
                        <div id="buffer2Fill" class="buffer-fill">0%</div>
                    </div>
                    <div class="arrow"></div>

                    <div class="station-container">
                        <div id="station3" class="station status-free">
                            <div class="station-id">S3</div>
                            <div id="station3Piece" class="piece-id"></div>
                            <div id="station3Time" class="remaining-time"></div>
                        </div>
                        <div class="progress-bar-container">
                            <div id="station3ProgressBar" class="progress-bar-fill"></div>
                        </div>
                        <div class="station-info">
                            <div id="station3DurationDisplay" class="duration-display">6.0s</div>
                            <div id="station3Status" class="status-display">free</div>
                        </div>
                    </div>
                    <div class="arrow"></div>

                    <div class="buffer-container">
                        <div id="buffer3" class="buffer">
                            <div class="buffer-id">B3</div>
                            <div id="buffer3Count" class="buffer-count">0/2</div>
                        </div>
                        <div id="buffer3Fill" class="buffer-fill">0%</div>
                    </div>
                    <div class="arrow"></div>

                    <div class="station-container">
                        <div id="station4" class="station status-free">
                            <div class="station-id">S4</div>
                            <div id="station4Piece" class="piece-id"></div>
                            <div id="station4Time" class="remaining-time"></div>
                        </div>
                        <div class="progress-bar-container">
                            <div id="station4ProgressBar" class="progress-bar-fill"></div>
                        </div>
                        <div class="station-info">
                            <div id="station4DurationDisplay" class="duration-display">3.0s</div>
                            <div id="station4Status" class="status-display">free</div>
                        </div>
                    </div>
                    <div class="arrow"></div>

                    <div class="buffer-container">
                        <div id="buffer4" class="buffer">
                            <div class="buffer-id">B4</div>
                            <div id="buffer4Count" class="buffer-count">0/2</div>
                        </div>
                        <div id="buffer4Fill" class="buffer-fill">0%</div>
                    </div>
                    <div class="arrow"></div>

                    <div class="station-container">
                        <div id="station5" class="station status-free">
                            <div class="station-id">S5</div>
                            <div id="station5Piece" class="piece-id"></div>
                            <div id="station5Time" class="remaining-time"></div>
                        </div>
                        <div class="progress-bar-container">
                            <div id="station5ProgressBar" class="progress-bar-fill"></div>
                        </div>
                        <div class="station-info">
                            <div id="station5DurationDisplay" class="duration-display">5.0s</div>
                            <div id="station5Status" class="status-display">free</div>
                        </div>
                    </div>
                    <div class="arrow"></div>

                    <div class="output-container">
                        <div class="output-box" id="outputBox">
                            <div class="output-label">OUT</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">üìà Throughput Rate (Parts/Hour)</h3>
                        <div class="button-group">
                            <button class="btn btn--outline btn--sm zoom-recent-btn" data-chart="throughputChart">Recent Zoom</button>
                            <button class="btn btn--outline btn--sm zoom-all-btn" data-chart="throughputChart">Full Zoom</button>
                        </div>
                    </div>
                    <div class="chart-container" style="position: relative; height: 250px;">
                        <canvas id="throughputChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">üìä Work in Process (WIP)</h3>
                        <div class="button-group">
                            <button class="btn btn--outline btn--sm zoom-recent-btn" data-chart="wipChart">Recent Zoom</button>
                            <button class="btn btn--outline btn--sm zoom-all-btn" data-chart="wipChart">Full Zoom</button>
                        </div>
                    </div>
                    <div class="chart-container" style="position: relative; height: 250px;">
                        <canvas id="wipChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">‚è±Ô∏è Lead Time Trend (seconds)</h3>
                        <div class="button-group">
                            <button class="btn btn--outline btn--sm zoom-recent-btn" data-chart="leadTimeChart">Recent Zoom</button>
                            <button class="btn btn--outline btn--sm zoom-all-btn" data-chart="leadTimeChart">Full Zoom</button>
                        </div>
                    </div>
                    <div class="chart-container" style="position: relative; height: 250px;">
                        <canvas id="leadTimeChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">üìä Lead Time Distribution (Histogram)</h3>
                    </div>
                    <div class="chart-container" style="position: relative; height: 250px;">
                        <canvas id="leadTimeHistogram"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">üî¨ Little's Law: WIP vs Throughput</h3>
                    </div>
                    <div class="chart-container" style="position: relative; height: 250px;">
                        <canvas id="littlesLawChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">üìä Cumulative Throughput: S1 vs S5</h3>
                        <div class="button-group">
                            <button class="btn btn--outline btn--sm zoom-recent-btn" data-chart="cumulativeThroughputChart">Recent Zoom</button>
                            <button class="btn btn--outline btn--sm zoom-all-btn" data-chart="cumulativeThroughputChart">Full Zoom</button>
                        </div>
                    </div>
                    <div class="chart-container" style="position: relative; height: 250px;">
                        <canvas id="cumulativeThroughputChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="gantt-panel">
                <h3>üóìÔ∏è Machine Activity Gantt Chart</h3>
                <div class="gantt-controls">
                    <label class="form-label">Time Window (sec):</label>
                    <input id="ganttWindowInput" type="number" class="form-control input-small" min="10" max="500" value="100">
                    <span class="gantt-info">Chart updates automatically during simulation</span>
                </div>
                <div class="gantt-container" id="ganttContainer">
                    <canvas id="ganttChart"></canvas>
                </div>
            </div>

            <div class="legend-panel">
                <h3>Station States Legend:</h3>
                <div class="legend-items">
                    <div class="legend-item"><div class="legend-color status-free"></div><span>Free</span></div>
                    <div class="legend-item"><div class="legend-color status-occupied"></div><span>Occupied (processing)</span></div>
                    <div class="legend-item"><div class="legend-color status-blocked"></div><span>Blocked (downstream buffer full)</span></div>
                </div>
                <h4>Utilization Metrics:</h4>
                <div class="legend-items">
                    <div class="legend-item"><strong>Occupied %:</strong> Time with piece (processing + blocked)</div>
                    <div class="legend-item"><strong>Processing %:</strong> Time actively processing (excluding blocked time)</div>
                </div>
                <h4>Parallel Machines:</h4>
                <div class="legend-items">
                    <div class="legend-item"><strong>"2/3"</strong> means 2 machines busy out of 3 total machines in the station</div>
                </div>
            </div>

            <div class="config-panel">
                <h3 class="config-title">‚öôÔ∏è Station Configuration</h3>
                <div class="stations-config">
                    <!-- Station 1 -->
                    <div class="station-config-card">
                        <label class="station-label">Station 1</label>
                        <div class="param-group" style="gap: 4px; margin-bottom: 8px;">
                            <label class="form-label-small">Parallel Machines</label>
                            <input id="station1Parallel" type="number" class="form-control station-input" min="1" max="10" value="1">
                        </div>
                        <div class="param-group" style="gap: 4px; margin-bottom: 8px;">
                            <label class="form-label-small">Batch Size (parts)</label>
                            <input id="station1Batch" type="number" class="form-control station-input" min="1" max="100" value="1">
                        </div>
                        <div class="param-group" style="gap: 4px; margin-bottom: 8px;">
                            <label class="form-label-small">OEE (0.0 - 1.0)</label>
                            <input id="station1OEE" type="number" class="form-control station-input" min="0.01" max="1.0" step="0.01" value="1.0">
                        </div>
                        <select id="station1Dist" class="form-control station-input">
                            <option value="deterministic" selected>Deterministic</option>
                            <option value="normal">Normal</option>
                            <option value="exponential">Exponential</option>
                            <option value="uniform">Uniform</option>
                            <option value="triangular">Triangular</option>
                        </select>
                        <div id="station1Params">
                            <div class="param-group" data-dist="deterministic exponential normal">
                                <label class="form-label-small">Mean (sec)</label>
                                <input id="station1Mean" type="number" class="form-control station-input" min="1" max="120" value="5">
                            </div>
                            <div class="param-group hidden" data-dist="normal">
                                <label class="form-label-small">Variance</label>
                                <input id="station1Variance" type="number" class="form-control station-input" min="0" max="100" value="1">
                            </div>
                            <div class="param-group hidden" data-dist="uniform triangular">
                                <label class="form-label-small">Min (sec)</label>
                                <input id="station1Min" type="number" class="form-control station-input" min="1" max="120" value="2">
                            </div>
                            <div class="param-group hidden" data-dist="uniform triangular">
                                <label class="form-label-small">Max (sec)</label>
                                <input id="station1Max" type="number" class="form-control station-input" min="1" max="120" value="8">
                            </div>
                            <div class="param-group hidden" data-dist="triangular">
                                <label class="form-label-small">Mode (sec)</label>
                                <input id="station1Mode" type="number" class="form-control station-input" min="1" max="120" value="5">
                            </div>
                        </div>
                        <div class="utilization-metrics">
                            <div id="station1Occupied" class="utilization-occupied">0.0% Occupied</div>
                            <div id="station1Processing" class="utilization-processing">0.0% Processing</div>
                        </div>
                    </div>

                    <!-- Station 2 -->
                    <div class="station-config-card">
                        <label class="station-label">Station 2</label>
                        <div class="param-group" style="gap: 4px; margin-bottom: 8px;">
                            <label class="form-label-small">Parallel Machines</label>
                            <input id="station2Parallel" type="number" class="form-control station-input" min="1" max="10" value="1">
                        </div>
                        <div class="param-group" style="gap: 4px; margin-bottom: 8px;">
                            <label class="form-label-small">Batch Size (parts)</label>
                            <input id="station2Batch" type="number" class="form-control station-input" min="1" max="100" value="1">
                        </div>
                        <div class="param-group" style="gap: 4px; margin-bottom: 8px;">
                            <label class="form-label-small">OEE (0.0 - 1.0)</label>
                            <input id="station2OEE" type="number" class="form-control station-input" min="0.01" max="1.0" step="0.01" value="1.0">
                        </div>
                        <select id="station2Dist" class="form-control station-input">
                            <option value="deterministic" selected>Deterministic</option>
                            <option value="normal">Normal</option>
                            <option value="exponential">Exponential</option>
                            <option value="uniform">Uniform</option>
                            <option value="triangular">Triangular</option>
                        </select>
                        <div id="station2Params">
                            <div class="param-group" data-dist="deterministic exponential normal">
                                <label class="form-label-small">Mean (sec)</label>
                                <input id="station2Mean" type="number" class="form-control station-input" min="1" max="120" value="4">
                            </div>
                            <div class="param-group hidden" data-dist="normal">
                                <label class="form-label-small">Variance</label>
                                <input id="station2Variance" type="number" class="form-control station-input" min="0" max="100" value="1">
                            </div>
                            <div class="param-group hidden" data-dist="uniform triangular">
                                <label class="form-label-small">Min (sec)</label>
                                <input id="station2Min" type="number" class="form-control station-input" min="1" max="120" value="2">
                            </div>
                            <div class="param-group hidden" data-dist="uniform triangular">
                                <label class="form-label-small">Max (sec)</label>
                                <input id="station2Max" type="number" class="form-control station-input" min="1" max="120" value="6">
                            </div>
                            <div class="param-group hidden" data-dist="triangular">
                                <label class="form-label-small">Mode (sec)</label>
                                <input id="station2Mode" type="number" class="form-control station-input" min="1" max="120" value="4">
                            </div>
                        </div>
                        <div class="utilization-metrics">
                            <div id="station2Occupied" class="utilization-occupied">0.0% Occupied</div>
                            <div id="station2Processing" class="utilization-processing">0.0% Processing</div>
                        </div>
                    </div>

                    <!-- Station 3 -->
                    <div class="station-config-card">
                        <label class="station-label">Station 3</label>
                        <div class="param-group" style="gap: 4px; margin-bottom: 8px;">
                            <label class="form-label-small">Parallel Machines</label>
                            <input id="station3Parallel" type="number" class="form-control station-input" min="1" max="10" value="1">
                        </div>
                        <div class="param-group" style="gap: 4px; margin-bottom: 8px;">
                            <label class="form-label-small">Batch Size (parts)</label>
                            <input id="station3Batch" type="number" class="form-control station-input" min="1" max="100" value="1">
                        </div>
                        <div class="param-group" style="gap: 4px; margin-bottom: 8px;">
                            <label class="form-label-small">OEE (0.0 - 1.0)</label>
                            <input id="station3OEE" type="number" class="form-control station-input" min="0.01" max="1.0" step="0.01" value="1.0">
                        </div>
                        <select id="station3Dist" class="form-control station-input">
                            <option value="deterministic" selected>Deterministic</option>
                            <option value="normal">Normal</option>
                            <option value="exponential">Exponential</option>
                            <option value="uniform">Uniform</option>
                            <option value="triangular">Triangular</option>
                        </select>
                        <div id="station3Params">
                            <div class="param-group" data-dist="deterministic exponential normal">
                                <label class="form-label-small">Mean (sec)</label>
                                <input id="station3Mean" type="number" class="form-control station-input" min="1" max="120" value="6">
                            </div>
                            <div class="param-group hidden" data-dist="normal">
                                <label class="form-label-small">Variance</label>
                                <input id="station3Variance" type="number" class="form-control station-input" min="0" max="100" value="1">
                            </div>
                            <div class="param-group hidden" data-dist="uniform triangular">
                                <label class="form-label-small">Min (sec)</label>
                                <input id="station3Min" type="number" class="form-control station-input" min="1" max="120" value="3">
                            </div>
                            <div class="param-group hidden" data-dist="uniform triangular">
                                <label class="form-label-small">Max (sec)</label>
                                <input id="station3Max" type="number" class="form-control station-input" min="1" max="120" value="9">
                            </div>
                            <div class="param-group hidden" data-dist="triangular">
                                <label class="form-label-small">Mode (sec)</label>
                                <input id="station3Mode" type="number" class="form-control station-input" min="1" max="120" value="6">
                            </div>
                        </div>
                        <div class="utilization-metrics">
                            <div id="station3Occupied" class="utilization-occupied">0.0% Occupied</div>
                            <div id="station3Processing" class="utilization-processing">0.0% Processing</div>
                        </div>
                    </div>

                    <!-- Station 4 -->
                    <div class="station-config-card">
                        <label class="station-label">Station 4</label>
                        <div class="param-group" style="gap: 4px; margin-bottom: 8px;">
                            <label class="form-label-small">Parallel Machines</label>
                            <input id="station4Parallel" type="number" class="form-control station-input" min="1" max="10" value="1">
                        </div>
                        <div class="param-group" style="gap: 4px; margin-bottom: 8px;">
                            <label class="form-label-small">Batch Size (parts)</label>
                            <input id="station4Batch" type="number" class="form-control station-input" min="1" max="100" value="1">
                        </div>
                        <div class="param-group" style="gap: 4px; margin-bottom: 8px;">
                            <label class="form-label-small">OEE (0.0 - 1.0)</label>
                            <input id="station4OEE" type="number" class="form-control station-input" min="0.01" max="1.0" step="0.01" value="1.0">
                        </div>
                        <select id="station4Dist" class="form-control station-input">
                            <option value="deterministic" selected>Deterministic</option>
                            <option value="normal">Normal</option>
                            <option value="exponential">Exponential</option>
                            <option value="uniform">Uniform</option>
                            <option value="triangular">Triangular</option>
                        </select>
                        <div id="station4Params">
                            <div class="param-group" data-dist="deterministic exponential normal">
                                <label class="form-label-small">Mean (sec)</label>
                                <input id="station4Mean" type="number" class="form-control station-input" min="1" max="120" value="3">
                            </div>
                            <div class="param-group hidden" data-dist="normal">
                                <label class="form-label-small">Variance</label>
                                <input id="station4Variance" type="number" class="form-control station-input" min="0" max="100" value="1">
                            </div>
                            <div class="param-group hidden" data-dist="uniform triangular">
                                <label class="form-label-small">Min (sec)</label>
                                <input id="station4Min" type="number" class="form-control station-input" min="1" max="120" value="1">
                            </div>
                            <div class="param-group hidden" data-dist="uniform triangular">
                                <label class="form-label-small">Max (sec)</label>
                                <input id="station4Max" type="number" class="form-control station-input" min="1" max="120" value="5">
                            </div>
                            <div class="param-group hidden" data-dist="triangular">
                                <label class="form-label-small">Mode (sec)</label>
                                <input id="station4Mode" type="number" class="form-control station-input" min="1" max="120" value="3">
                            </div>
                        </div>
                        <div class="utilization-metrics">
                            <div id="station4Occupied" class="utilization-occupied">0.0% Occupied</div>
                            <div id="station4Processing" class="utilization-processing">0.0% Processing</div>
                        </div>
                    </div>

                    <!-- Station 5 -->
                    <div class="station-config-card">
                        <label class="station-label">Station 5</label>
                        <div class="param-group" style="gap: 4px; margin-bottom: 8px;">
                            <label class="form-label-small">Parallel Machines</label>
                            <input id="station5Parallel" type="number" class="form-control station-input" min="1" max="10" value="1">
                        </div>
                        <div class="param-group" style="gap: 4px; margin-bottom: 8px;">
                            <label class="form-label-small">Batch Size (parts)</label>
                            <input id="station5Batch" type="number" class="form-control station-input" min="1" max="100" value="1">
                        </div>
                        <div class="param-group" style="gap: 4px; margin-bottom: 8px;">
                            <label class="form-label-small">OEE (0.0 - 1.0)</label>
                            <input id="station5OEE" type="number" class="form-control station-input" min="0.01" max="1.0" step="0.01" value="1.0">
                        </div>
                        <select id="station5Dist" class="form-control station-input">
                            <option value="deterministic" selected>Deterministic</option>
                            <option value="normal">Normal</option>
                            <option value="exponential">Exponential</option>
                            <option value="uniform">Uniform</option>
                            <option value="triangular">Triangular</option>
                        </select>
                        <div id="station5Params">
                            <div class="param-group" data-dist="deterministic exponential normal">
                                <label class="form-label-small">Mean (sec)</label>
                                <input id="station5Mean" type="number" class="form-control station-input" min="1" max="120" value="5">
                            </div>
                            <div class="param-group hidden" data-dist="normal">
                                <label class="form-label-small">Variance</label>
                                <input id="station5Variance" type="number" class="form-control station-input" min="0" max="100" value="1">
                            </div>
                            <div class="param-group hidden" data-dist="uniform triangular">
                                <label class="form-label-small">Min (sec)</label>
                                <input id="station5Min" type="number" class="form-control station-input" min="1" max="120" value="2">
                            </div>
                            <div class="param-group hidden" data-dist="uniform triangular">
                                <label class="form-label-small">Max (sec)</label>
                                <input id="station5Max" type="number" class="form-control station-input" min="1" max="120" value="8">
                            </div>
                            <div class="param-group hidden" data-dist="triangular">
                                <label class="form-label-small">Mode (sec)</label>
                                <input id="station5Mode" type="number" class="form-control station-input" min="1" max="120" value="5">
                            </div>
                        </div>
                        <div class="utilization-metrics">
                            <div id="station5Occupied" class="utilization-occupied">0.0% Occupied</div>
                            <div id="station5Processing" class="utilization-processing">0.0% Processing</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="config-panel buffer-config-panel">
                <h3 class="config-title">üì¶ Buffer Configuration</h3>
                <div class="buffers-config">
                    <div class="buffer-config">
                        <label class="buffer-label">Buffer 1 (S1 ‚Üí S2)</label>
                        <input id="buffer1Capacity" type="number" class="form-control station-input" min="0" max="100" value="2">
                        <div id="buffer1Status" class="buffer-status">Current: 0/2 (0%)</div>
                        <div id="buffer1AvgUtilization" class="buffer-avg-util">Avg Util: 0.0%</div>
                    </div>
                    <div class="buffer-config">
                        <label class="buffer-label">Buffer 2 (S2 ‚Üí S3)</label>
                        <input id="buffer2Capacity" type="number" class="form-control station-input" min="0" max="100" value="2">
                        <div id="buffer2Status" class="buffer-status">Current: 0/2 (0%)</div>
                        <div id="buffer2AvgUtilization" class="buffer-avg-util">Avg Util: 0.0%</div>
                    </div>
                    <div class="buffer-config">
                        <label class="buffer-label">Buffer 3 (S3 ‚Üí S4)</label>
                        <input id="buffer3Capacity" type="number" class="form-control station-input" min="0" max="100" value="2">
                        <div id="buffer3Status" class="buffer-status">Current: 0/2 (0%)</div>
                        <div id="buffer3AvgUtilization" class="buffer-avg-util">Avg Util: 0.0%</div>
                    </div>
                    <div class="buffer-config">
                        <label class="buffer-label">Buffer 4 (S4 ‚Üí S5)</label>
                        <input id="buffer4Capacity" type="number" class="form-control station-input" min="0" max="100" value="2">
                        <div id="buffer4Status" class="buffer-status">Current: 0/2 (0%)</div>
                        <div id="buffer4AvgUtilization" class="buffer-avg-util">Avg Util: 0.0%</div>
                    </div>
                </div>
            </div>

            <div class="export-panel">
                <h3 class="config-title">üìÑ Export Data</h3>
                <button id="exportLogBtn" class="btn btn--secondary">üíæ Export Log (.csv)</button>
            </div>

            <div class="config-panel" style="background-color: var(--color-bg-6);">
                <h3 class="config-title">‚öôÔ∏è Configuration Save / Load</h3>
                <div class="button-group" style="justify-content: space-between;">
                    <button id="saveConfigBtn" class="btn btn--primary">‚¨áÔ∏è Save Config (JSON)</button>
                    <button id="loadConfigBtn" class="btn btn--outline">‚¨ÜÔ∏è Load Config (JSON)</button>
                </div>
                <input type="file" id="configFileInput" accept=".json" style="display:none;">
            </div>

            <div class="preset-panel">
                <h3 class="config-title">‚ö° Load Configuration Presets</h3>
                <div class="preset-group">
                    <button class="btn btn--secondary preset-button" data-preset="balanced">Balanced Line</button>
                    <button class="btn btn--secondary preset-button" data-preset="bottleneck">Bottleneck (S3)</button>
                    <button class="btn btn--secondary preset-button" data-preset="high-volatility">High Volatility</button>
                </div>
            </div>

            <div class="preset-panel">
                <h3 class="config-title">üíæ Saved Configurations</h3>
                <div class="saved-config-controls">
                    <div class="input-group" style="flex: 1;">
                        <input id="configNameInput" type="text" class="form-control" placeholder="Enter configuration name..." style="flex: 1;">
                        <button id="saveConfigLocalBtn" class="btn btn--primary">üíæ Save Current</button>
                    </div>
                </div>
                <div id="savedConfigsList" class="saved-configs-list" style="margin-top: 12px;">
                    <!-- Saved configurations will be dynamically inserted here -->
                </div>
            </div>

        </div>
    </div>

    <!-- External JavaScript -->
    <script src="simulator.js"></script>

    <!-- Saved Configurations Management -->
    <script>
        // =============================================
        // SAVED CONFIGURATIONS UI
        // =============================================

        function renderSavedConfigurationsList() {
            const listContainer = document.getElementById('savedConfigsList');
            const savedConfigs = window.simulator.getSavedConfigurations();

            // Filter out autosave
            const userConfigs = Object.entries(savedConfigs).filter(([name]) => name !== '__autosave__');

            if (userConfigs.length === 0) {
                listContainer.innerHTML = '<div class="empty-state">No saved configurations yet. Enter a name and click "Save Current" to save your first configuration.</div>';
                return;
            }

            listContainer.innerHTML = userConfigs.map(([name, data]) => {
                const date = new Date(data.timestamp);
                const formattedDate = date.toLocaleString();

                return `
                    <div class="saved-config-item">
                        <div class="saved-config-info">
                            <div class="saved-config-name">${name}</div>
                            <div class="saved-config-timestamp">Saved: ${formattedDate}</div>
                        </div>
                        <div class="saved-config-actions">
                            <button class="btn btn--sm btn--primary" onclick="loadSavedConfig('${name}')">üìÇ Load</button>
                            <button class="btn btn--sm btn--outline" onclick="deleteSavedConfig('${name}')">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function saveSavedConfig() {
            const nameInput = document.getElementById('configNameInput');
            const name = nameInput.value.trim();

            if (!name) {
                alert('Please enter a configuration name');
                return;
            }

            if (name === '__autosave__') {
                alert('This name is reserved. Please choose another name.');
                return;
            }

            const success = window.simulator.saveToLocalStorage(name);
            if (success) {
                nameInput.value = '';
                renderSavedConfigurationsList();
                alert(`Configuration "${name}" saved successfully!`);
            } else {
                alert('Error saving configuration. Please try again.');
            }
        }

        function loadSavedConfig(name) {
            const success = window.simulator.loadFromLocalStorage(name);
            if (success) {
                console.log(`Configuration "${name}" loaded`);
            } else {
                alert(`Error loading configuration "${name}"`);
            }
        }

        function deleteSavedConfig(name) {
            if (confirm(`Are you sure you want to delete configuration "${name}"?`)) {
                const success = window.simulator.deleteFromLocalStorage(name);
                if (success) {
                    renderSavedConfigurationsList();
                } else {
                    alert(`Error deleting configuration "${name}"`);
                }
            }
        }

        function setupSavedConfigsUI() {
            // Save button handler
            document.getElementById('saveConfigLocalBtn').addEventListener('click', saveSavedConfig);

            // Enter key in name input
            document.getElementById('configNameInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    saveSavedConfig();
                }
            });

            // Load autosave if available
            window.simulator.loadAutoSave();

            // Render initial list
            renderSavedConfigurationsList();

            // Auto-save on parameter changes
            const autoSaveInputs = [
                'wipInput', 'logStepInput', 'zoomWindowInput', 'warmupPeriodInput',
                'buffer1Capacity', 'buffer2Capacity', 'buffer3Capacity', 'buffer4Capacity'
            ];

            autoSaveInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', () => {
                        setTimeout(() => window.simulator.autoSave(), 500);
                    });
                }
            });

            // Auto-save for station parameters
            for (let i = 1; i <= 5; i++) {
                ['Dist', 'OEE', 'Batch', 'Parallel', 'Mean', 'Variance', 'Min', 'Max', 'Mode'].forEach(param => {
                    const element = document.getElementById(`station${i}${param}`);
                    if (element) {
                        element.addEventListener('change', () => {
                            setTimeout(() => window.simulator.autoSave(), 500);
                        });
                    }
                });
            }

            console.log('‚úÖ Saved configurations UI initialized');
        }

        // Initialize when simulator is ready
        window.addEventListener('load', () => {
            // Wait a bit for simulator to be fully initialized
            setTimeout(setupSavedConfigsUI, 100);
        });

        // Make functions globally accessible
        window.loadSavedConfig = loadSavedConfig;
        window.deleteSavedConfig = deleteSavedConfig;
    </script>

    <!-- Tooltips Initialization -->
    <script>
        // =============================================
        // TOOLTIPS FOR PARAMETERS
        // =============================================

        const tooltipData = {
            'Constant WIP:': 'Work In Process - Numero fisso di pezzi nella linea. Principio del pull system: un nuovo pezzo entra solo quando uno esce.',
            'Speed:': 'Velocit√† di simulazione. Aumenta per vedere risultati pi√π velocemente.',
            'Log Step (sec):': 'Frequenza di registrazione delle metriche. Valori pi√π bassi = pi√π punti dati, ma maggiore uso di memoria.',
            'Zoom Window (sec):': 'Finestra temporale mostrata nei grafici durante la simulazione. Auto-zoom sugli ultimi N secondi.',
            'Warm-up (sec):': 'Periodo iniziale di "riscaldamento" prima di raccogliere statistiche. Utile per raggiungere stato stazionario.',
            'Time Window (sec):': 'Durata della finestra temporale del diagramma di Gantt.',
            'Distribution:': 'Distribuzione probabilistica dei tempi di processo. Deterministic = fisso, Normal = gaussiana, Exponential = code casuali, Uniform = uniforme, Triangular = triangolare.',
            'Mean (sec):': 'Tempo medio di processo per pezzo (o batch).',
            'Variance:': 'Varianza della distribuzione normale. Valori pi√π alti = maggiore variabilit√†.',
            'Min (sec):': 'Tempo minimo di processo.',
            'Max (sec):': 'Tempo massimo di processo.',
            'Mode (sec):': 'Valore pi√π probabile nella distribuzione triangolare.',
            'OEE:': 'Overall Equipment Effectiveness (0-1). Efficienza complessiva della macchina. 1.0 = 100% efficiente, 0.8 = 80% efficiente.',
            'Batch Size:': 'Numero di pezzi processati insieme. Batch > 1 significa che la macchina lavora su pi√π pezzi simultaneamente.',
            'Parallel Machines:': 'Numero di macchine parallele alla stazione. Pi√π macchine = maggiore capacit√†.',
            'Capacity:': 'Capacit√† massima del buffer. Numero massimo di pezzi che pu√≤ contenere tra due stazioni.'
        };

        function addTooltips() {
            // Find all labels
            const labels = document.querySelectorAll('.form-label, .config-label');

            labels.forEach(label => {
                const labelText = label.textContent.trim();

                // Check if we have tooltip data for this label
                if (tooltipData[labelText]) {
                    // Create tooltip wrapper
                    const wrapper = document.createElement('span');
                    wrapper.className = 'tooltip-wrapper';

                    // Create tooltip icon
                    const icon = document.createElement('span');
                    icon.className = 'tooltip-icon';
                    icon.textContent = '?';

                    // Create tooltip text
                    const tooltipText = document.createElement('span');
                    tooltipText.className = 'tooltip-text';
                    tooltipText.textContent = tooltipData[labelText];

                    // Assemble tooltip
                    wrapper.appendChild(icon);
                    wrapper.appendChild(tooltipText);

                    // Insert after label
                    label.appendChild(wrapper);
                }
            });

            console.log('‚úÖ Tooltips initialized');
        }

        // Initialize tooltips when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', addTooltips);
        } else {
            addTooltips();
        }
    </script>
    <!-- PWA & Theme Management -->
    <script>
        // =============================================
        // THEME MANAGEMENT
        // =============================================

        // Load saved theme preference or detect system preference
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const themeToggleBtn = document.getElementById('themeToggle');
            const themeIcon = themeToggleBtn.querySelector('.theme-icon');

            if (savedTheme) {
                document.documentElement.classList.toggle('dark-theme', savedTheme === 'dark');
                document.documentElement.classList.toggle('light-theme', savedTheme === 'light');
                themeIcon.textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            } else {
                // Check system preference
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                themeIcon.textContent = prefersDark ? '‚òÄÔ∏è' : 'üåô';
            }

            // Theme toggle handler
            themeToggleBtn.addEventListener('click', () => {
                const isDark = document.documentElement.classList.contains('dark-theme');

                if (isDark) {
                    document.documentElement.classList.remove('dark-theme');
                    document.documentElement.classList.add('light-theme');
                    themeIcon.textContent = 'üåô';
                    localStorage.setItem('theme', 'light');
                } else {
                    document.documentElement.classList.remove('light-theme');
                    document.documentElement.classList.add('dark-theme');
                    themeIcon.textContent = '‚òÄÔ∏è';
                    localStorage.setItem('theme', 'dark');
                }
            });
        }

        // Initialize theme on load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initTheme);
        } else {
            initTheme();
        }

        // =============================================
        // PWA INSTALL BUTTON
        // =============================================

        let deferredPrompt;
        const installBtn = document.getElementById('installBtn');

        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent the mini-infobar from appearing on mobile
            e.preventDefault();
            // Stash the event so it can be triggered later
            deferredPrompt = e;

            // Show install button
            installBtn.style.display = 'inline-flex';
            console.log('üíæ PWA install prompt available');
        });

        installBtn.addEventListener('click', async () => {
            if (!deferredPrompt) {
                return;
            }

            // Show the install prompt
            deferredPrompt.prompt();

            // Wait for the user to respond to the prompt
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`User response to the install prompt: ${outcome}`);

            // Clear the deferredPrompt
            deferredPrompt = null;

            // Hide install button
            installBtn.style.display = 'none';
        });

        window.addEventListener('appinstalled', () => {
            console.log('‚úÖ PWA installed successfully');
            deferredPrompt = null;
            installBtn.style.display = 'none';
        });

        // =============================================
        // SERVICE WORKER REGISTRATION
        // =============================================

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('‚úÖ Service Worker registered successfully:', registration.scope);

                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            console.log('üîÑ Service Worker update found');

                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New service worker available, prompt user to refresh
                                    if (confirm('New version available! Reload to update?')) {
                                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.error('‚ùå Service Worker registration failed:', error);
                    });

                // Handle service worker updates
                let refreshing = false;
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    if (!refreshing) {
                        refreshing = true;
                        window.location.reload();
                    }
                });
            });
        } else {
            console.warn('‚ö†Ô∏è Service Workers are not supported in this browser');
        }
    </script>

    <!-- Station Progress Rings -->
    <script>
        // =============================================
        // PROGRESS BAR FOR STATIONS
        // =============================================

        let updateCount = 0;
        function updateProgressBars() {
            if (!window.simulator) {
                console.log('‚ö†Ô∏è window.simulator is not defined');
                return;
            }

            updateCount++;
            // Log every 10th update to avoid spam
            const shouldLog = updateCount % 10 === 0;

            const stations = window.simulator.stations;

            if (shouldLog) console.log(`--- Update #${updateCount} ---`);

            stations.forEach((station, index) => {
                const stationId = `station${index + 1}`;
                const progressBarFill = document.getElementById(`${stationId}ProgressBar`);
                if (!progressBarFill) return;

                // Get the first machine
                const machine = station.machines[0];

                if (shouldLog) {
                    console.log(`S${index + 1}: status=${machine.status}, remaining=${machine.remainingTime}, initial=${machine.initialTime}`);
                }

                if (machine && machine.status === 'occupied' && machine.remainingTime !== undefined && machine.initialTime) {
                    // Calculate progress (0 to 100%)
                    const totalTime = machine.initialTime;
                    const elapsed = totalTime - machine.remainingTime;
                    const progress = Math.max(0, Math.min(100, (elapsed / totalTime) * 100));

                    // Update progress bar width
                    progressBarFill.style.width = progress + '%';

                    if (shouldLog) {
                        console.log(`  ‚Üí S${index + 1} Progress: ${progress.toFixed(1)}% (width set to ${progress.toFixed(1)}%)`);
                    }
                } else {
                    // Reset to 0% when not occupied
                    progressBarFill.style.width = '0%';
                }
            });
        }

        // Initialize on load
        window.addEventListener('load', () => {
            setTimeout(() => {
                // Test: force all progress bars to 50% to verify they work
                console.log('=== TESTING PROGRESS BARS ===');
                for (let i = 1; i <= 5; i++) {
                    const bar = document.getElementById(`station${i}ProgressBar`);
                    if (bar) {
                        bar.style.width = '50%';
                        console.log(`‚úì Station ${i} progress bar set to 50% width`);
                    } else {
                        console.log(`‚úó Station ${i} progress bar NOT FOUND`);
                    }
                }
                console.log('=== Bars should now be green at 50% ===');

                // After 3 seconds, start the normal update loop
                setTimeout(() => {
                    console.log('=== Starting normal updates ===');
                    // Reset bars
                    for (let i = 1; i <= 5; i++) {
                        const bar = document.getElementById(`station${i}ProgressBar`);
                        if (bar) bar.style.width = '0%';
                    }

                    // Update progress bars every 100ms when simulation is running
                    setInterval(updateProgressBars, 100);
                }, 3000);
            }, 500);
        });
    </script>
</body>
</html>